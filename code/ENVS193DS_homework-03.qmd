---
title: "ENVS193DS_homework-03"
author: "Maya Bernstein"
format: html
html: 
    toc: true # includes a table of contents in rendered html format
execute: # for all code chunks
    warning: FALSE # do not display warnings
    message: FALSE # do not display messages
---

## Link to Repository *add link*

```{r}
# general use
library(tidyverse)
library(readxl)
library(here)
library(janitor)

# visualizing pairs
library(GGally)

# model selection
library(MuMIn)

# model predictions
library(ggeffects)

# model tables
library(gtsummary)
library(flextable)
library(modelsummary)

drought_exp <- read_xlsx(path = here("data", 
                                     "Valliere_etal_EcoApps_Data.xlsx"),
                         sheet = "First Harvest")

# quick look at data 
str(drought_exp)
class(drought_exp)
```

```{r}
# cleaning
drought_exp_clean <- drought_exp %>% 
  clean_names() %>% # nicer column names
  mutate(species_name = case_when( # adding column with species scientific names
    species == "ENCCAL" ~ "Encelia californica", # bush sunflower
    species == "ESCCAL" ~ "Eschscholzia californica", # California poppy
    species == "PENCEN" ~ "Penstemon centranthifolius", # Scarlet bugler
    species == "GRICAM" ~ "Grindelia camporum", # great valley gumweed
    species == "SALLEU" ~ "Salvia leucophylla", # Purple sage
    species == "STIPUL" ~ "Nasella pulchra", # Purple needlegrass
    species == "LOTSCO" ~ "Acmispon glaber" # deerweed
  )) %>% 
  relocate(species_name, .after = species) %>% # moving species_name column after species
  mutate(water_treatment = case_when( # adding column with full treatment names
    water == "WW" ~ "Well watered",
    water == "DS" ~ "Drought stressed"
  )) %>% 
  relocate(water_treatment, .after = water) # moving water_treatment column after water
```

# Question 1

## **Creating models**

#### Model 0 - null

```{r}
#null model
model0 <- lm(total_g ~ 1, # formula
             data = drought_exp_clean) # data frame
```

#### Model 1 - total biomass as a function of SLA, water treatment, and species

```{r}
# saturated model
model1 <- lm(total_g ~ sla + water_treatment + species_name, #formula
             data = drought_exp_clean) #dataframe
```

#### Model 2 - total biomass as a function of SLA and water treatment

```{r}
model2 <- lm(total_g ~ sla + water_treatment, #formula w correct predictors
             data = drought_exp_clean) #dataframe
```

#### Model 3 - total biomass as a function of SLA and species

```{r}
model3 <- lm(total_g ~ sla + species_name, #formula
             data = drought_exp_clean) #dataframe
```

#### Model 4 - **total biomass as a function of water treatment and species**

```{r}
model4 <- lm(total_g ~ water_treatment + species_name, #formula
             data = drought_exp_clean) #dataframe
```

### a. Table of Models

|                                                                                                                                                                                                                                                                                                                                                                        |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Table 1: Comparison of Regression Models**. This table shows the five regression models used to predict total biomass (g): "Null," "Model 1," "Model 2," "Model 3," and "Model 4." Each column is a seperate model. The header row indicates the predictor variable in question and check marks in the rows indicate that predictor variable was used in the model.  |

| Predictors                                              | Null | Model 1 | Model 2 | Model 3 | Model 4 |
|------------|------------|------------|------------|------------|------------|
| **Specific Leaf Area** (mm^2^/g)                        |      | ✓       | ✓       | ✓       |         |
| **Watering Level (well watered vs drought conditions)** |      | ✓       | ✓       |         | ✓       |
| **Species Type**                                        |      | ✓       |         | ✓       | ✓       |

### b. Statistical Methods

To examine the influence of specific leaf area (mm^2^/g), watering level (well watered vs drought stressed, and species type on total biomass, I compared the five models outlined in the table above in order to determine which predictor variables best influence total biomass. I used the `model.sel` function from the `MuMIn` package which uses corrected (for smaller sample size) Akaike Information Criterion (AICc) to rank the provided models according to their AICc values. Model 4, which looks at total biomass as a function of water treatment and species, has the lowest AICc value (-156.2) and highest weight (0.772), indicating it is the best model among those compared. To evaluate linear model assumptions, I used the `plot` for each model to evaluate the diagnostic plots for residuals vs fitted values, the Normal Q-Q plot, the Scale-Location plot, and the residuals vs. leverage plot. These visual checks confirmed the models were homoscedastic, normally distributed, and linear.

### c. Visualization

```{r}
#first need to get model prediction values
model_preds <- ggpredict(model4, #using model 4
                         terms = c("water_treatment", #predictor terms within model 4
                                   "species_name"))
```

```{r}
#make new dataframe 
model_preds_for_plotting <- model_preds %>%  #make a new df from the model predictions df
  rename(water_treatment = x, # renaming columns to make them match drought_exp_clean names
         species_name = group)
ggplot() +
# underlying data
  geom_point(data = drought_exp_clean, #using the clean data
             aes(x = water_treatment, # x axis is water treatment
                 y = total_g, #y axis is total biomass 
                 color = water_treatment), #color the points based on water treatment
             alpha = 0.25)+ #make the underlying points more transparent
  scale_color_manual(values = c("#C4A484", "#228B22"))+  # Specify colors for each group

#model data
   geom_point(data = model_preds_for_plotting, #using dataframe I made above
             aes(x = water_treatment, # x axis is water treatment
                 y = predicted, #y axis is predicted total biomass (g)
                 color = water_treatment), #color based on water treatment 
             size = 2.5,  # Making model prediction points larger for visibility
             shape = 17) +  # Changing shape to triangle for better differentiation
  # Cleaner theme
  theme_classic() +

  # Add labels 
  labs(x = "Water Treatment", y = "Total Mass (mm2/g)", title = "Model Predictions vs. Data by Species and Watering Conditions") +
  
# Remove legend
  theme(legend.position = "none") +
  
# Creating different panels for species
  facet_wrap(~species_name)
```
